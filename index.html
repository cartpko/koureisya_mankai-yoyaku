<!--
LIFF 面会予約フォーム
使い方（要作業）
1) このファイルを GitHub にアップして GitHub Pages で公開（HTTPS が必要）
2) LINE Developers の LIFF にこの公開URLを登録（または既存の liffId を使用）
   - あなたの LIFF ID: 2008012163-poQVL3Bk
3) Google スプレッドシートを作成し、下記の列名でシート1を用意
   A: Timestamp
   B: 入居者名
   C: 面会者名
   D: 希望日
   E: 希望時間
   F: 電話番号
   G: 備考
   H: LIFF_USER_ID (任意)
4) Google Apps Script を作り、下の "Apps Script (doPost)" コードを使って Web アプリとしてデプロイ
   - 実行ユーザー: 自分
   - アクセス: 全員（匿名）にする（組織に合わせて調整）
5) デプロイした Web アプリの URL をこのファイルの GAS_ENDPOINT に貼り付け
6) LINE公式アカウントのリッチメニューや応答メッセージにこの LIFF をリンクすれば完了

※ セキュリティ: 本サンプルは学習・試作向けです。実運用では認証、スパム対策（reCAPTCHA等）、入力検証、個人情報保護の対策を必ず行ってください。
-->

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>面会予約フォーム（老人ホーム）</title>
  <style>
    :root{--bg:#f8fafc;--card:#ffffff;--accent:#2b6cb0;--muted:#6b7280}
    html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", "Meiryo", sans-serif;background:var(--bg);color:#111}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:720px;background:var(--card);border-radius:12px;box-shadow:0 6px 24px rgba(15,23,42,0.08);padding:28px}
    h1{font-size:20px;margin:0 0 8px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    form{display:grid;gap:12px}
    label{display:flex;flex-direction:column;font-size:14px}
    input[type=text], input[type=date], input[type=time], input[type=tel], textarea, select{
      padding:12px;border:1px solid #e6edf3;border-radius:8px;font-size:16px}
    textarea{min-height:88px;resize:vertical}
    .row{display:flex;gap:12px}
    .row > label{flex:1}
    button{background:var(--accent);color:#fff;padding:12px;border-radius:10px;border:0;font-size:16px;cursor:pointer}
    button[disabled]{opacity:0.6;cursor:default}
    .meta{font-size:13px;color:var(--muted);display:flex;justify-content:space-between;align-items:center}
    .success{background:#ecfdf5;border:1px solid #bbf7d0;padding:12px;border-radius:8px;color:#065f46}
    .error{background:#fff1f2;border:1px solid #fecaca;padding:12px;border-radius:8px;color:#9f1239}
    footer{margin-top:16px;font-size:13px;color:var(--muted);text-align:center}
    @media (max-width:520px){.card{padding:18px}}
  </style>
</head>
<body>
  <div class="wrap">
    <main class="card" role="main">
      <h1>面会予約フォーム</h1>
      <p class="lead">家族・友人の方が入居者へ面会を申し込むためのフォームです。LINEから自動で開く想定です。</p>

      <div id="status" aria-live="polite"></div>

      <form id="visitForm" autocomplete="off">
        <label for="resident">入居者名（必須）
          <input id="resident" name="resident" type="text" required maxlength="80" placeholder="例：山田 太郎">
        </label>

        <label for="visitor">面会者名（必須）
          <input id="visitor" name="visitor" type="text" required maxlength="80" placeholder="あなたのお名前">
        </label>

        <div class="row">
          <label for="date">希望日（必須）
            <input id="date" name="date" type="date" required>
          </label>
          <label for="time">希望時間（必須）
            <input id="time" name="time" type="time" required>
          </label>
        </div>

        <label for="phone">電話番号（任意）
          <input id="phone" name="phone" type="tel" maxlength="20" placeholder="09012345678">
        </label>

        <label for="note">備考（任意）
          <textarea id="note" name="note" placeholder="例：午前中希望、車で来ます 等"></textarea>
        </label>

        <div class="meta">
          <span>入力内容を確認して送信してください</span>
          <button id="submitBtn" type="submit">予約を送信</button>
        </div>
      </form>

      <footer>
        このフォームはデモ用です。個人情報の取り扱いに注意してください。
      </footer>
    </main>
  </div>

  <script>
    // === 必須：Google Apps Script の Web アプリ URL をここに貼る ===
    const GAS_ENDPOINT = 'https://script.google.com/a/macros/ict.shimanet.ed.jp/s/AKfycbxGmPkUgSSvgG5P5chQjkRCIsRNmf7ZXq0oJO_3x21leIlV-lFQRXmUrrsOE9bj8iWg/exec'; // ← ここに置き換えてください

    // LIFF ID（ユーザーが提供済み）
    const LIFF_ID = '2008012163-poQVL3Bk';

    // UI 要素
    const form = document.getElementById('visitForm');
    const status = document.getElementById('status');
    const submitBtn = document.getElementById('submitBtn');

    let liffUserId = '';

    async function initLiff() {
      if (!window.liff) {
        // liff SDK がない場合（GitHub Pages 等で直接開いたとき）
        console.warn('LIFF SDK が読み込まれていません。LINE内で開いているか確認してください。');
        return;
      }
      try {
        await liff.init({ liffId: LIFF_ID });
        if (liff.isLoggedIn()) {
          const profile = await liff.getProfile();
          liffUserId = profile.userId || '';
        } else {
          // LIFF 内なら login させる選択肢もあるが今回は任意
          try { await liff.login(); } catch (e) { console.log('login canceled'); }
        }
      } catch (err) {
        console.error(err);
      }
    }

    // 初期化：LIFF SDK の読み込みを試みる
    (function loadLiffSdk(){
      const s = document.createElement('script');
      s.src = 'https://static.line-scdn.net/liff/edge/2/sdk.js';
      s.onload = initLiff;
      document.head.appendChild(s);
    })();

    function showMessage(type, text){
      status.innerHTML = `<div class="${type}">${text}</div>`;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      showMessage('','');

      const payload = {
        resident: document.getElementById('resident').value.trim(),
        visitor: document.getElementById('visitor').value.trim(),
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        phone: document.getElementById('phone').value.trim(),
        note: document.getElementById('note').value.trim(),
        liffUserId: liffUserId
      };

      // 簡単なバリデーション
      if (!payload.resident || !payload.visitor || !payload.date || !payload.time) {
        showMessage('error','必須項目が入力されていません。');
        submitBtn.disabled = false;
        return;
      }

      try {
        const res = await fetch(GAS_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (res.ok && data.result === 'success'){
          showMessage('success', '予約を受け付けました。施設からの連絡をお待ちください。');
          form.reset();
        } else {
          throw new Error(data.message || '送信に失敗しました');
        }
      } catch (err) {
        console.error(err);
        showMessage('error', '送信中にエラーが発生しました。もう一度お試しください。');
      } finally {
        submitBtn.disabled = false;
      }
    });

  </script>

  <!--
  ========== Apps Script (doPost) サンプル ==========
  以下を Google Apps Script のファイルに貼り付け、プロジェクトをデプロイして Web アプリ URL を取得してください。

  // Code.gs
  function doPost(e){
    try{
      var data = {};
      if (e.postData && e.postData.type === 'application/json'){
        data = JSON.parse(e.postData.contents);
      } else if (e.parameter){
        data = e.parameter; // フォーム送信形式
      }

      var ss = SpreadsheetApp.openById('YOUR_SHEET_ID'); // ← スプレッドシートIDを入れてください
      var sheet = ss.getSheetByName('シート1') || ss.getSheets()[0];

      // 列の並び: Timestamp, 入居者名, 面会者名, 希望日, 希望時間, 電話番号, 備考, LIFF_USER_ID
      var row = [new Date(), data.resident||'', data.visitor||'', data.date||'', data.time||'', data.phone||'', data.note||'', data.liffUserId||''];
      sheet.appendRow(row);

      return ContentService
        .createTextOutput(JSON.stringify({result:'success'}))
        .setMimeType(ContentService.MimeType.JSON);
    } catch(err){
      return ContentService
        .createTextOutput(JSON.stringify({result:'error', message: err.message}))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }

  デプロイ時の注意:
  - 「次のユーザーとしてアプリケーションを実行」: 自分（オーナー）
  - 「アプリケーションにアクセスできるユーザー」: 全員（匿名）

  セキュリティ上の注意:
  - 公開URLが誰でも投稿できるため、スパム対策や入力チェック、IP制限（可能なら）を検討してください。
  -->

</body>
</html>
